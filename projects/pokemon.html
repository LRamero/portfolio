<!DOCTYPE html>
<html>
<head>
    <title>A combatir!</title>
    <link rel="stylesheet" href="/projects/assets/css-pokemon-gameboy.css">
    <link rel="icon" type="image/x-icon" href="/projects/assets/images/pk.ico">
</head>
<body>
    <section class="framed neutral">
        <section>
            <h1>Simulador de combates Pokemon</h1>
            <div class="framed secondary">
                <div id="encabezado">
                    <div class="modo">
                        <h3>Selecciona modo de juego</h3>
                        <ul>
                            <form id="JvC">
                                <button type="button" secondary data-show-pk-life-container>Jugador contra Computadora</button>
                            </form>
                        </ul>
                        <ul>
                            <form id="JvJ">
                                <button type="button" secondary data-show-pk-life-container>Jugador contra Jugador</button>
                            </form>
                        </ul>
                        <ul>
                            <form id="CvC">
                                <button type="button" secondary data-show-pk-life-container>Computadora contra Computadora</button>
                            </form>
                        </ul>
                    </div>
                    <div class="atras">
                        <h3>Elige a los combatientes!</h3>
                        <ul>
                            <form id="atras_modo">
                                <button type="button" secondary atras_modo>Atras</button>
                            </form>
                        </ul>
                    </div>
                    <div id="encabezado_msj"
                </div>
            </div>
        </section>
        <section class="pk-life-container">
            <div id='pk_life1'>
                <ul id="pk1" class=pk>
                    <label for="pokemon1">Pokémon 1:</label><select name="pokemon1" id="pokemon1">
                        {% for valor in pk_list %}
                            <option value="{{valor}}">{{valor}}</option>
                        {% endfor %}
                    </select>
                </ul>
                <ul id="pk1_life"></ul>
                <div id='pk_ability1'>
                    <ul class=pk>
                        <label for="pk1_ability1">Habilidad 1:</label><select name="pk1_ability1" id="pk1_ability1">
                            {% for ability in abilities1 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability2'>
                    <ul class=pk>
                        <label for="pk1_ability2">Habilidad 2:</label><select name="pk1_ability2" id="pk1_ability2">
                            {% for ability in abilities1 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability3'>
                    <ul class=pk>
                        <label for="pk1_ability3">Habilidad 3:</label><select name="pk1_ability3" id="pk1_ability3">
                            {% for ability in abilities1 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability4'>
                    <ul class=pk>
                        <label for="pk1_ability4">Habilidad 4:</label><select name="pk1_ability4" id="pk1_ability4">
                            {% for ability in abilities1 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
            </div>
            <div id='boton'>
                <ul class=pk>
                    <form id="ejecutar-script" action="/pokemon_combat" method="post">
                        <button secondary>Iniciar</button>
                    </form>
                </ul>
            </div>
            <div id='pk_life2'>
                <ul id="pk2" class=pk>
                    <label for="pokemon2">Pokémon 2:</label><select name="pokemon2" id="pokemon2">
                        {% for valor in pk_list %}
                            <option value="{{valor}}">{{valor}}</option>
                        {% endfor %}
                    </select>
                </ul>
                <ul id="pk2_life"></ul>
                <div id='pk_ability1'>
                    <ul class=pk>
                        <label for="pk2_ability1">Habilidad 1:</label><select name="pk2_ability1" id="pk2_ability1">
                            {% for ability in abilities2 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability2'>
                    <ul class=pk>
                        <label for="pk2_ability2">Habilidad 2:</label><select name="pk2_ability2" id="pk2_ability2">
                            {% for ability in abilities2 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability3'>
                    <ul class=pk>
                        <label for="pk2_ability3">Habilidad 3:</label><select name="pk2_ability3" id="pk2_ability3">
                            {% for ability in abilities2 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
                <div id='pk_ability4'>
                    <ul class=pk>
                        <label for="pk2_ability4">Habilidad 4:</label><select name="pk2_ability4" id="pk2_ability4">
                            {% for ability in abilities2 %}
                            <option value="{{ ability }}">{{ ability }}</option>
                            {% endfor %}
                        </select>
                    </ul>
                </div>
            </div>
        </section>
        <section id="resultado" class="resultado">
        </section>
    </section>
    <script>
        const encabezado = document.getElementById("encabezado_msj");
        const form = document.getElementById("ejecutar-script");
        const resultado = document.getElementById("resultado");
        const pk1 = document.getElementById("pk1");
        const pk2 = document.getElementById("pk2");
        const pk1_life = document.getElementById("pk1_life");
        const pk2_life = document.getElementById("pk2_life");
        const button = form.querySelector("button");
        const abilityDivs = document.querySelectorAll('[id^="pk"][id*="_ability"]');
        const pokemon1Select = document.getElementById("pokemon1");
        const pk1_ability1Select = document.getElementById("pk1_ability1");
        const pk1_ability2Select = document.getElementById("pk1_ability2");
        const pk1_ability3Select = document.getElementById("pk1_ability3");
        const pk1_ability4Select = document.getElementById("pk1_ability4");
        const pokemon2Select = document.getElementById("pokemon2");
        const pk2_ability1Select = document.getElementById("pk2_ability1");
        const pk2_ability2Select = document.getElementById("pk2_ability2");
        const pk2_ability3Select = document.getElementById("pk2_ability3");
        const pk2_ability4Select = document.getElementById("pk2_ability4");
        const pkLifeContainer = document.querySelector('.pk-life-container');
        const modo = document.querySelector('.modo');
        const atras_modo = document.querySelector('.atras');
        const buttons = document.querySelectorAll('button[secondary][data-show-pk-life-container]');
        const button_atras = document.querySelector('button[secondary][atras_modo]');

        button.addEventListener("click", (e) => {
            atras_modo.style.display = "none";
            const pokemon1 = document.getElementById("pokemon1").value;
            const pokemon2 = document.getElementById("pokemon2").value;
            const pk1_ability1 = document.getElementById("pk1_ability1").value;
            const pk1_ability2 = document.getElementById("pk1_ability2").value; 
            const pk1_ability3 = document.getElementById("pk1_ability3").value; 
            const pk1_ability4 = document.getElementById("pk1_ability4").value; 
            const pk2_ability1 = document.getElementById("pk2_ability1").value; 
            const pk2_ability2 = document.getElementById("pk2_ability2").value; 
            const pk2_ability3 = document.getElementById("pk2_ability3").value; 
            const pk2_ability4 = document.getElementById("pk2_ability4").value;
            button.style.display = "none";
            e.preventDefault();
            fetch("/pokemon_combat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({pokemon1, pokemon2, pk1_ability1, pk1_ability2, pk1_ability3, pk1_ability4, pk2_ability1, pk2_ability2, pk2_ability3, pk2_ability4})
            })
                .then((response) => {
                    if (response.ok) {
                        const eventSource = new EventSource("/pokemon_combat_stream");
                        eventSource.onmessage = (event) => {
                            if (event.data.includes("Cargando valores...")) {
                                encabezado.innerHTML = "Cargando valores...";
                                pk1_life.innerHTML = "<ul class=pk>" + pokemon1 + "</ul>";
                                pk2_life.innerHTML = "<ul class=pk>" + pokemon2 + "</ul>";
                                pk1.style.display = "none";
                                pk2.style.display = "none";
                                resultado.innerHTML = "";
                                abilityDivs.forEach((div) => div.style.display = "none");
                            }
                            else if (event.data.includes("pk1")) {
                                const partes = event.data.split(',');
                                const v_max = partes[partes.length - 2];
                                const vida = partes[partes.length - 1];
                                porcentaje = Math.round((vida / v_max) * 100).toString()
                                pk1_life.innerHTML = "<ul id=pk1_life class=pk><div class= progress-bar-container><label for= pk1>" + partes[1] + "</label><progress id=pk1 class=p" + porcentaje + " value=" +
                                    vida + " max=" + v_max + "></progress> " + vida + "/" + v_max + "</div></ul>";
                            }
                            else if (event.data.includes("pk2")) {
                                const partes = event.data.split(',');
                                const v_max = partes[partes.length - 2];
                                const vida = partes[partes.length - 1];
                                porcentaje = Math.round((vida / v_max) * 100).toString();
                                pk2_life.innerHTML = "<ul id=pk2_life class=pk><div class= progress-bar-container><label for= pk2>" + partes[1] + "</label><progress id=pk2 class=p" + porcentaje + " value=" +
                                    vida + " max=" + v_max + "></progress> " + vida + "/" + v_max + "</div></ul>";
                            }
                            else if (event.data.includes("%")) {
                                encabezado.innerHTML = "<div class=progress-bar-container><label for=carga>Cargando valores...</label><progress id=cargar class=p" + Number(event.data.substring(0, 3)).toString() + " value=" +
                                    event.data.substring(0, 3) + " max=100></progress></div>\n";
                            }
                            else if ((event.data == "Definiendo parámetros...") | (event.data == "Comenzando el combate...")) {
                                encabezado.innerHTML += event.data + "<br>";
                            }
                            else if (event.data.includes("El ganador")) {
                                encabezado.innerHTML += "Combate finalizado. " + event.data + "<br>";
                                pk1_life.innerHTML = '';
                                pk2_life.innerHTML = '';
                                pk1.style.display = "block";
                                pk2.style.display = "block";
                                button.style.display = "block";
                                abilityDivs.forEach((div) => div.style.display = "block");
                                atras_modo.style.display = "block";
                            }
                            else if (event.data.includes("Error!!")) {
                                if (!(encabezado.innerHTML.includes("El ganador"))){
                                    resultado.innerHTML = "";
                                    encabezado.innerHTML += "Combate finalizado. " + event.data + "<br>";
                                    pk1_life.innerHTML = '';
                                    pk2_life.innerHTML = '';
                                    pk1.style.display = "block";
                                    pk2.style.display = "block";
                                    button.style.display = "block";
                                    abilityDivs.forEach((div) => div.style.display = "block"); 
                                    atras_modo.style.display = "block";
                                }
                            }
                            else {
                                resultado.innerHTML += event.data + "<br>";
                            }
                        };
                        eventSource.onerror = () => {
                            console.log("Error al conectar con el servidor");
                        };
                        eventSource.onopen = () => {
                            console.log("Conexión establecida con el servidor");
                        };
                    } else {
                        console.log("Error al iniciar la ejecución del script");
                    }
                })
                .catch((error) => {
                    console.log("Error al iniciar la ejecución del script", error);
                });
        })

        pokemon1Select.addEventListener("change", async () => {
            const pokemon1Value = pokemon1Select.value;
            const response = await fetch("/get_abilities1", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ pokemon1: pokemon1Value })
            });
            const abilities1 = await response.json();
            pk1_ability1Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability1Select.appendChild(option);
            });
            pk1_ability2Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability2Select.appendChild(option);
            });
            pk1_ability3Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability3Select.appendChild(option);
            });
            pk1_ability4Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability4Select.appendChild(option);
            });
        });
        
        pokemon2Select.addEventListener("change", async () => {
            const pokemon2Value = pokemon2Select.value;
            const response = await fetch("/get_abilities2", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ pokemon2: pokemon2Value })
            });
            const abilities2 = await response.json();
            pk2_ability1Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability1Select.appendChild(option);
            });
            pk2_ability2Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability2Select.appendChild(option);
            });
            pk2_ability3Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability3Select.appendChild(option);
            });
            pk2_ability4Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability4Select.appendChild(option);
            });
        });

        buttons.forEach((button) => {
            button.addEventListener('click', (e) => {
                e.preventDefault(); // previene el comportamiento predeterminado del botón
                pkLifeContainer.style.display = "flex";
                modo.style.display = "none";
                atras_modo.style.display = "block";
            });
        });

        button_atras.addEventListener("click", (e) => {
            e.preventDefault();
            modo.style.display = "block";
            atras_modo.style.display = "none";
            pkLifeContainer.style.display = "none";
            encabezado.innerHTML = "";
            resultado.innerHTML = "";
        });</script>
</body>
</html>