<!DOCTYPE html>
<html>
<head>
    <title>A combatir!</title>
    <link rel="stylesheet" href="/projects/assets/css-pokemon-gameboy.css">
    <link rel="icon" type="image/x-icon" href="/projects/assets/images/pk.ico">
</head>
<body>
    <section class="framed neutral">
        <section>
            <h1>Simulador de combates Pokemon</h1>
            <div class=progress-bar-container id="carga_datos">Prueba</div>
            <div class="framed secondary">
                <div id="encabezado">
                    <div class="modo">
                        <h3>Selecciona modo de juego</h3>
                        <ul>
                            <form id="JvC">
                                <button type="button" secondary JvC>Jugador contra Computadora</button>
                            </form>
                        </ul>
                        <ul>
                            <form id="JvJ">
                                <button type="button" secondary JvJ>Jugador contra Jugador</button>
                            </form>
                        </ul>
                        <ul>
                            <form id="CvC">
                                <button type="button" secondary CvC>Computadora contra Computadora</button>
                            </form>
                        </ul>
                    </div>
                    <div class="atras">
                        <h3>Elige a los combatientes!</h3>
                        <ul>
                            <form id="atras_modo">
                                <button type="button" secondary atras_modo>Atras</button>
                            </form>
                        </ul>
                    </div>
                    <div id="encabezado_msj"></div>
                </div>
            </div>
        </section>
            <section class="pk-life-container">
                <div id='pk_life1'>
                    <ul id="pk1" class=pk>
                        <label for="pokemon1">Pokémon 1:</label><select name="pokemon1" id="pokemon1">
                            {% for valor in pk_list %}
                                <option value="{{valor}}">{{valor}}</option>
                            {% endfor %}
                        </select>
                    </ul>
                    <div id='pk_ability1'>
                        <ul class=pk>
                            <label for="pk1_ability1">Habilidad 1:</label><select name="pk1_ability1" id="pk1_ability1">
                                {% for ability in abilities1 %}
                                    <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability2'>
                        <ul class=pk>
                            <label for="pk1_ability2">Habilidad 2:</label><select name="pk1_ability2" id="pk1_ability2">
                                {% for ability in abilities1 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability3'>
                        <ul class=pk>
                            <label for="pk1_ability3">Habilidad 3:</label><select name="pk1_ability3" id="pk1_ability3">
                                {% for ability in abilities1 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability4'>
                        <ul class=pk>
                            <label for="pk1_ability4">Habilidad 4:</label><select name="pk1_ability4" id="pk1_ability4">
                                {% for ability in abilities1 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id="pk1_life"></div>
                </div>
                <div id='boton'>
                    <ul class=pk>
                        <form id="ejecutar-JvC" action="/pokemon_combatJvC" method="post">
                            <button secondary inicio_JvC>Iniciar J1vsCOM</button>
                        </form>
                        <form id="ejecutar-JvJ" action="/pokemon_combatJvJ" method="post">
                            <button secondary inicio_JvJ>Iniciar J1vsJ2</button>
                        </form>
                        <form id="ejecutar-CvC" action="/pokemon_combatCvC" method="post">
                            <button secondary inicio_CvC>Iniciar COMvsCOM</button>
                        </form>
                    </ul>
                </div>
                <div id='pk_life2'>
                    <ul id="pk2" class=pk>
                        <label for="pokemon2">Pokémon 2:</label><select name="pokemon2" id="pokemon2">
                            {% for valor in pk_list %}
                                <option value="{{valor}}">{{valor}}</option>
                            {% endfor %}
                        </select>
                    </ul>
                    <div id='pk_ability1'>
                        <ul class=pk>
                            <label for="pk2_ability1">Habilidad 1:</label><select name="pk2_ability1" id="pk2_ability1">
                                {% for ability in abilities2 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability2'>
                        <ul class=pk>
                            <label for="pk2_ability2">Habilidad 2:</label><select name="pk2_ability2" id="pk2_ability2">
                                {% for ability in abilities2 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability3'>
                        <ul class=pk>
                            <label for="pk2_ability3">Habilidad 3:</label><select name="pk2_ability3" id="pk2_ability3">
                                {% for ability in abilities2 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id='pk_ability4'>
                        <ul class=pk>
                            <label for="pk2_ability4">Habilidad 4:</label><select name="pk2_ability4" id="pk2_ability4">
                                {% for ability in abilities2 %}
                                <option value="{{ ability }}">{{ ability }}</option>
                                {% endfor %}
                            </select>
                        </ul>
                    </div>
                    <div id="pk2_life"></div>
                </div>
            </section>
        <section id="resultado" class="resultado">
        </section>
    </section>
    <script>
        const encabezado = document.getElementById("encabezado_msj");
        const form_JvC = document.getElementById("ejecutar-JvC");
        const form_JvJ = document.getElementById("ejecutar-JvJ");
        const form_CvC = document.getElementById("ejecutar-CvC");
        const resultado = document.getElementById("resultado");
        const pk1 = document.getElementById("pk1");
        const pk2 = document.getElementById("pk2");
        const pk1_life = document.getElementById("pk1_life");
        const pk2_life = document.getElementById("pk2_life");
        const button_inicio_JvJ = form_JvJ.querySelector("button[secondary][inicio_JvJ]");
        const button_inicio_JvC = form_JvC.querySelector("button[secondary][inicio_JvC]");
        const button_inicio_CvC = form_CvC.querySelector("button[secondary][inicio_CvC]");
        const button_JvJ = document.querySelector('button[secondary][JvJ]');
        const button_JvC = document.querySelector('button[secondary][JvC]');
        const button_CvC = document.querySelector('button[secondary][CvC]');
        const button_atras = document.querySelector('button[secondary][atras_modo]');
        const abilityDivs = document.querySelectorAll('[id^="pk"][id*="_ability"]');
        const pokemon1Select = document.getElementById("pokemon1");
        const pk1_ability1Select = document.getElementById("pk1_ability1");
        const pk1_ability2Select = document.getElementById("pk1_ability2");
        const pk1_ability3Select = document.getElementById("pk1_ability3");
        const pk1_ability4Select = document.getElementById("pk1_ability4");
        const pokemon2Select = document.getElementById("pokemon2");
        const pk2_ability1Select = document.getElementById("pk2_ability1");
        const pk2_ability2Select = document.getElementById("pk2_ability2");
        const pk2_ability3Select = document.getElementById("pk2_ability3");
        const pk2_ability4Select = document.getElementById("pk2_ability4");
        const pkLifeContainer = document.querySelector('.pk-life-container');
        const modo = document.querySelector('.modo');
        const atras_modo = document.querySelector('.atras');
        const barra_datos = document.getElementById('carga_datos');
        
        window.addEventListener('load', function () {
            fetch("/pokemon_load")
                .then((response) => {
                    if (response.ok) {
                        const eventSource = new EventSource("/pokemon_load_stream");
                        eventSource.onmessage = (event) => {
                            barra_datos.innerHTML = "<div class=progress-bar-container><label for=carga>Cargando valores...</label><progress id=cargar class=p" + Number(event.data.substring(0, 3)).toString() + " value=" +
                                event.data.substring(0, 3) + " max=100></progress></div>\n";
                        };
                    };
                })
                .catch((error) => {
                    console.log("Error al iniciar la ejecución del script", error);
                });
        });

        function acciones(response) {
            const pokemon1 = document.getElementById("pokemon1").value;
            const pokemon2 = document.getElementById("pokemon2").value;
            if (response.ok) {
                const eventSource = new EventSource("/pokemon_combat_stream");
                eventSource.onmessage = (event) => {
                    if (event.data.includes("Cargando valores...")) {
                        encabezado.innerHTML = "Cargando valores...";
                        pk1_life.innerHTML = "<ul class=pk>" + pokemon1 + "</ul>";
                        pk2_life.innerHTML = "<ul class=pk>" + pokemon2 + "</ul>";
                        pk1.style.display = "none";
                        pk2.style.display = "none";
                        resultado.innerHTML = "";
                        abilityDivs.forEach((div) => div.style.display = "none");
                    }
                    else if (event.data.includes("pk1")) {
                        const partes = event.data.split(',');
                        const v_max = partes[partes.length - 2];
                        const vida = partes[partes.length - 1];
                        porcentaje = Math.round((vida / v_max) * 100).toString()
                        pk1_life.innerHTML = "<ul id=pk1_life class=pk><div class= progress-bar-container><label for= pk1>" + partes[1] + "</label><progress id=pk1 class=p" + porcentaje + " value=" +
                            vida + " max=" + v_max + "></progress> " + vida + "/" + v_max + "</div></ul>";
                    }
                    else if (event.data.includes("pk2")) {
                        const partes = event.data.split(',');
                        const v_max = partes[partes.length - 2];
                        const vida = partes[partes.length - 1];
                        porcentaje = Math.round((vida / v_max) * 100).toString();
                        pk2_life.innerHTML = "<ul id=pk2_life class=pk><div class= progress-bar-container><label for= pk2>" + partes[1] + "</label><progress id=pk2 class=p" + porcentaje + " value=" +
                            vida + " max=" + v_max + "></progress> " + vida + "/" + v_max + "</div></ul>";
                    }
                    else if (event.data.includes("%")) {
                        encabezado.innerHTML = "<div class=progress-bar-container><label for=carga>Cargando valores...</label><progress id=cargar class=p" + Number(event.data.substring(0, 3)).toString() + " value=" +
                            event.data.substring(0, 3) + " max=100></progress></div>\n";
                    }
                    else if ((event.data == "Definiendo parámetros...") | (event.data == "Comenzando el combate...")) {
                        encabezado.innerHTML += event.data + "<br>";
                    }
                    else if (event.data.includes("El ganador")) {
                        encabezado.innerHTML += "Combate finalizado. " + event.data + "<br>";
                        pk1.style.display = "block";
                        pk2.style.display = "block";
                        button_inicio_CvC.style.display = "block";
                        abilityDivs.forEach((div) => div.style.display = "block");
                        atras_modo.style.display = "block";

                    }
                    else if (event.data.includes("Error!!")) {
                        if (!(encabezado.innerHTML.includes("El ganador"))) {
                            resultado.innerHTML = "";
                            encabezado.innerHTML += "Combate finalizado. " + event.data + "<br>";
                            pk1_life.innerHTML = '';
                            pk2_life.innerHTML = '';
                            pk1.style.display = "block";
                            pk2.style.display = "block";
                            button_inicio_CvC.style.display = "block";
                            abilityDivs.forEach((div) => div.style.display = "block");
                            atras_modo.style.display = "block";
                        }
                    }
                    else {
                        resultado.innerHTML += event.data + "<br>";
                    }
                };
                eventSource.onerror = () => {
                    console.log("Error al conectar con el servidor");
                };
                eventSource.onopen = () => {
                    console.log("Conexión establecida con el servidor");
                };
            } else {
                console.log("Error al iniciar la ejecución del script");
            }
        }

        button_inicio_CvC.addEventListener("click", (e) => {
            atras_modo.style.display = "none";
            const pokemon1 = document.getElementById("pokemon1").value;
            const pokemon2 = document.getElementById("pokemon2").value;
            const pk1_ability1 = document.getElementById("pk1_ability1").value;
            const pk1_ability2 = document.getElementById("pk1_ability2").value; 
            const pk1_ability3 = document.getElementById("pk1_ability3").value; 
            const pk1_ability4 = document.getElementById("pk1_ability4").value; 
            const pk2_ability1 = document.getElementById("pk2_ability1").value; 
            const pk2_ability2 = document.getElementById("pk2_ability2").value; 
            const pk2_ability3 = document.getElementById("pk2_ability3").value; 
            const pk2_ability4 = document.getElementById("pk2_ability4").value;
            button_inicio_CvC.style.display = "none";
            e.preventDefault();
            fetch("/pokemon_combat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({modo_combate: "CvC", pokemon1, pokemon2, pk1_ability1, pk1_ability2, pk1_ability3, pk1_ability4, pk2_ability1, pk2_ability2, pk2_ability3, pk2_ability4})
            })
                .then((response) => {
                    acciones(response);
                })
                .catch((error) => {
                    console.log("Error al iniciar la ejecución del script", error);
                });
        })

        pokemon1Select.addEventListener("change", async () => {
            const pokemon1Value = pokemon1Select.value;
            barra_datos.innerHTML = pokemon1Value;
            const response =  await fetch("/get_abilities", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ pokemon: pokemon1Value })
            });
            const abilities1 = await response.json();
            pk1_ability1Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability1Select.appendChild(option);
            });
            pk1_ability2Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability2Select.appendChild(option);
            });
            pk1_ability3Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability3Select.appendChild(option);
            });
            pk1_ability4Select.innerHTML = "";
            abilities1.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk1_ability4Select.appendChild(option);
            });
        });
        
        pokemon2Select.addEventListener("change", async () => {
            const pokemon2Value = pokemon2Select.value;
            barra_datos.innerHTML = pokemon2Value;
            const response = await fetch("/get_abilities", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ pokemon: pokemon2Value })
            });
            const abilities2 = await response.json();
            pk2_ability1Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability1Select.appendChild(option);
            });
            pk2_ability2Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability2Select.appendChild(option);
            });
            pk2_ability3Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability3Select.appendChild(option);
            });
            pk2_ability4Select.innerHTML = "";
            abilities2.forEach((ability) => {
                const option = document.createElement("option");
                option.value = ability;
                option.text = ability;
                pk2_ability4Select.appendChild(option);
            });
        });

        button_CvC.addEventListener('click', (e) => {
            e.preventDefault(); // previene el comportamiento predeterminado del botón
            fetch("/get_pokemon")
                .then(
                    response => response.json()
                )
                .then(pk_list => {
                    pokemon1Select.innerHTML = "";
                    pokemon2Select.innerHTML = "";
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon1Select.appendChild(option);
                    });
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon2Select.appendChild(option);
                    });
                    pokemon1Select.selectedIndex = 0;
                    pokemon2Select.selectedIndex = 0;
                    pkLifeContainer.style.display = "flex";
                    modo.style.display = "none";
                    atras_modo.style.display = "block";
                    form_JvC.style.display = "none";
                    form_JvJ.style.display = "none";
                });
        });

        button_JvJ.addEventListener('click', (e) => {
            e.preventDefault(); // previene el comportamiento predeterminado del botón
            fetch("/get_pokemon")
                .then(
                    response => response.json()
                )
                .then(pk_list => {
                    pokemon1Select.innerHTML = "";
                    pokemon2Select.innerHTML = "";
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon1Select.appendChild(option);
                    });
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon2Select.appendChild(option);
                    });
                    pokemon1Select.selectedIndex = 0;
                    pokemon2Select.selectedIndex = 0;
                    pkLifeContainer.style.display = "flex";
                    modo.style.display = "none";
                    atras_modo.style.display = "block";
                    form_JvC.style.display = "none";
                    form_CvC.style.display = "none";
                });
        });

        button_JvC.addEventListener('click', (e) => {
            e.preventDefault(); // previene el comportamiento predeterminado del botón
            fetch("/get_pokemon")
                .then(
                    response => response.json()
                )
                .then(pk_list => {
                    pokemon1Select.innerHTML = "";
                    pokemon2Select.innerHTML = "";
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon1Select.appendChild(option);
                    });
                    pk_list.forEach((pk) => {
                        const option = document.createElement("option");
                        option.value = pk;
                        option.text = pk;
                        pokemon2Select.appendChild(option);
                    });
                    pokemon1Select.selectedIndex = 0;
                    pokemon2Select.selectedIndex = 0;
                    pkLifeContainer.style.display = "flex";
                    modo.style.display = "none";
                    atras_modo.style.display = "block";
                    form_CvC.style.display = "none";
                    form_JvJ.style.display = "none";
                });
        });

        button_atras.addEventListener("click", (e) => {
            e.preventDefault();
            modo.style.display = "block";
            atras_modo.style.display = "none";
            pkLifeContainer.style.display = "none";
            encabezado.innerHTML = "";
            resultado.innerHTML = "";
            form_JvC.style.display = "block";
            form_JvJ.style.display = "block";
            form_CvC.style.display = "block";
            pk1_life.innerHTML = "";
            pk2_life.innerHTML = "";
        });</script>
</body>
</html>